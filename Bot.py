import asyncio
import logging
import re
import os
import json
from datetime import datetime, date
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.types import Message, CallbackQuery, BufferedInputFile, FSInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramUnauthorizedError, TelegramBadRequest
from pathlib import Path
import io
import aiofiles
from collections import defaultdict

# --- Конфигурация ---
BOT_TOKEN = os.getenv("BOT_TOKEN", "8570934146:AAGanyRQTlA2yGXA9BIjMGMmh71KaIQUv-M")
ADMIN_USER_IDS = [1075151569]
CHANNEL_ID = "-1002070668053"  # ID канала для проверки подписки
CHANNEL_LINK = "https://t.me/mynumerolog_bubigo"  # Ссылка на канал

# --- Пути к файлам ---
BASE_DIR = Path(__file__).parent.resolve()
USER_DATA_FILE = BASE_DIR / "user_data.json"
ACTIONS_LOG_FILE = BASE_DIR / "actions_log.json"
STATISTICS_FILE = BASE_DIR / "statistics.json"
MONTH_PHOTOS_DIR = BASE_DIR / "photo/month"

# --- Глобальные переменные ---
user_profiles = {}
user_actions_log = []
statistics = {
    'total_messages': 0,
    'total_calculations': 0,
    'total_month_calculations': 0,
    'total_year_calculations': 0,
    'bot_start_time': datetime.now().isoformat(),
    'session_start_time': datetime.now().isoformat(),
    'date_frequency': defaultdict(int)
}
session_messages_count = 0
save_lock = asyncio.Lock()

# --- Названия месяцев ---
MONTH_NAMES = {
    1: "Январь", 2: "Февраль", 3: "Март", 4: "Апрель",
    5: "Май", 6: "Июнь", 7: "Июль", 8: "Август",
    9: "Сентябрь", 10: "Октябрь", 11: "Ноябрь", 12: "Декабрь"
}

# --- База текстов (ВСТАВЬТЕ СЮДА ВАШУ ПЕРЕМЕННУЮ KONTROLNYE_TEXTY) ---
KONTROLNYE_TEXTY = {
    3: {
        "kontrolnye": "тревога по поводу денег и рождения детей; безразличие, холодность и отсутствие интереса ко всему, что раньше вызывало интерес; обиды и память о неудачах, всё, что порождает страх и неуверенность, окрашивает год в тёмные тона; сожаления, угрызения совести, бесполезные терзания, которые ведут к самобичеванию, а не исцелению; упрямство – внутреннее качество, не позволяющее тебе отступить от своего поведения, даже если оно неправильное; враждебность окружающих – другие люди могут вести себя недружелюбно, побуждая отвечать тем же; обман и лицемерие, заметив ложь в окружающих, ты хочешь обрушить на них свой гнев.",
        "strategiya": "реализовываться; делегировать на работе и дома; по-матерински управлять командой, не взваливать на себя все задачи; вкладывать усилия в проекты, которые приносят осязаемые плоды; начинать творческие проекты, предварительно вынашивая идею; принимать амбициозные предложения по работе; не лишать себя роли хозяйки домашнего очага; рожать, воспитывать, развивать детей; налаживать отношения с женщинами; бывать в обществе женщин-единомышленниц; выделять время для ухода за собой, хобби, реализацию; отдыхать на природе; изучать секреты построения гармоничных отношений в паре; изучать мужскую и женскую энергию. Дополнительно женщинам: принимать мужчину, вдохновлять его, принимать его силу, авторитет, власть, признавать в нем мужское начало; прорабатывать отношения с мамой, не держать обид на нее и женщин в целом; давать мужчине возможность решать, вдохновлять мужчину на взятие ответственности. Дополнительно мужчинам: разобраться с мамой, т.к. если ты злишься на маму (критикуешь, не принимаешь ее, обижаешь, не понимаешь), то в этот период ты не сможешь позаботиться о женщине рядом; укреплять мужскую энергию; не перекладывать ответственность, не искать, кто бы решил твои вопросы, а самому решить для себя и почувствовать себя взрослым, сильным мужчиной."
    },
    4: {
        "kontrolnye": "ощущение внутренней агрессии и злости; кажется что деньги даются тяжелым трудом и сейчас не время зарабатывать; трудоголизм; давление на членов семьи, попытка контролировать всех домашних; страх потерять контроль и власть; провокации окружающих – ощущая твою слабость, другие задевают твои гордость и чувства; соблазны и слабости – ситуации, связанные с тайными желаниями, пристрастиями и тёмными сторонами личности; отвлечение, отсутствие сосредоточенности, трудно фокусироваться на одном; возможность избежать ответственности, когда появится удобный случай для лжи и отказа от обязательств.",
        "strategiya": "брать ответственность за свою жизнь; развиваться как эксперт; расслабляться и отдыхать; переставать всех контролировать; повышать навыки управления командой; учиться работать с людьми; изучать принципы ненасильственного общения; улучшать профессиональные качества; улучшать свой статус и положение в обществе, строить карьеру; создавать и развивать собственный бизнес, управлять людьми; строить дом; решать проблемы с отцом, другими родственниками-мужчинами, особенно с бывшими партнерами, так как недоговорённости, конфликты и обиды, незавершённые отношения могут сильно помешать реализации положительных судьбоносных моментов. Дополнительно женщинам: принимать мужчину, вдохновлять его, принимать его силу, авторитет, власть, признавать в нем мужское начало; прорабатывать отношения с папой, не держать обид на него и мужчин в целом; давать мужчине возможность решать, вдохновлять мужчину на взятие ответственности. Дополнительно мужчинам: разобраться с папой, т.к. если ты не имеешь хороших отношений с ним, то тебе будет тяжело подняться по социальной лестнице, как минимум нужен авторитет в виде другого мужчины, смотря на которого, ты бы получал опыт; укреплять мужскую энергию; не перекладывать ответственность, не искать, кто бы решил твои вопросы, а самому решить для себя и почувствовать себя взрослым, сильным мужчиной."
    },
    5: {
        "kontrolnye": "потеря авторитета, самоценности; возрастающий синдром самозванца; ощущение, что знания никому не нужны, люди не готовы развиваться и образовываться; застой в получении новой информации, скатывание в старые модели поведения, шаблоны и устои; зависимость мнения со стороны, давление родственников; ощущение, что правила давят со всех сторон; появляется чувство 'я должен'; жизнь по шаблону; непонимание окружающих, вызывающее желание доказать свою правоту или вступить в спор; недоразумения и происшествия, лишающие уверенности в себе; обвинения и сплетни со стороны окружающих; хаос, отсутствие единства, условия, вынуждающие устанавливать свои порядки и вести себя деспотично.",
        "strategiya": "проявлять внимание к той информации, что тебе поступает; брать деньги за свой труд; не обесценивать себя и свои знания; учиться и учить; развивать гибкость и толерантность по отношению к людям; пересматривать свои догматично 'правильные' взгляды; создавать семью, вступать в брак, рожать детей; смещать фокус на семью и дела близких. соблюдая баланс (не жить жизнью родственников, не бунтарствовать); устанавливать новые традиции в роду; поддерживать здоровые уважительные отношения со старшими в роду, оказывая внимание и заботу; наводить порядок в делах, доме, эмоциях и мыслях; проживать свою жизнь и действовать по своему разумению, в рамках сформированной системы внутренних ценностей; соблюдать режим дня и систематизировать свою жизнь."
    },
    6: {
        "kontrolnye": "кажется, что будущее уже предопределено и ты в этой жизни ничего не решаешь; усталость, неудачи – испытывая отчаяние, ты можешь опустить руки, бросить начатое дело; невозможность делать собственные выборы; пропадает желание радоваться и наслаждаться жизнью, ощущение, что это неуместно; проблемы в отношениях с собой, партнером, друзьями; созависимость в отношениях; боязнь людей и новых знакомств; желание навредить, а не утешить, гневные слова, упрёки и замечания, которые пробуждают ответное желание причинить боль; изоляция, не выходишь на улицу, ни с кем не общаешься, погружаешься исключительно в себя и отрываешься от реальности; самодовольство, успешно справившись с делами, считаешь это исключительно своей заслугой.",
        "strategiya": "влюбляться и строить отношения; выходить из созависимости; позволять себе романтику и страсть; проявлять нежность, ласку и получать ее в ответ от других; проявлять инициативу, если возникают обиды и недопонимания; сглаживать конфликты; дружить и сотрудничать с людьми; выстраивать гармоничное, равное партнерство, где учтены интересы всех; познавать врагов: через негатив ты учишься распознавать людей, видеть все как есть и не жить в розовых очках; налаживать связи с партнерами по бизнесу; раскрывать коммуникативные способности; создавать красоту и уют в окружающем пространстве; ухаживать за собой, подчеркивать свою красоту; долюбливать себя; баловать себя, делать себе подарки, тратить на себя деньги; поддерживать все сферы в балансе; идти за своими ощущениями, не действуя по указке или желаниям, интересам других; делать собственные выборы сердцем; узнавать себя, что для тебя важно, чего ты хочешь; планировать появление детей; выделять время для хобби, особенно творческих."
    },
    7: {
        "kontrolnye": "застой в жизни, время остановилось, а ты обездвижена; ощущение, что ты не находишься у штурвала своего корабл, а плывешь по течению; все цели и планы на будущее не зажигают или их просто нет, старые цели могут казаться нереальными; чувство неотложности – ощущение, возникающее всякий раз, когда ты боишься упустить возможность или шанс на успех; паника или внутренняя тревога, не позволяющая расслабиться или сосредоточиться на чём-то одном; мелкие и не связанные между собой дела, не имеющие общей цели и быстро утомляющие тебя; отсутствие быстрых результатов, когда ты делаешь большую работу, но не видишь плодов своего труда сразу же.",
        "strategiya": "развивать лидерские качества; достигать нового, искать новые цели, источники вдохновения; намечать конкретную цель, вырабатывать план и двигаться по нему; научиться работать над достижением цели, возможно, с помощью наставника; идти только к достижению своих целей, а не чужих; научиться планировать; быть деятельной, активной; путешествовать, отправляться в командировки; покупать автомобиль, учиться вождению транспорта; переезжать; менять жильё; откликаться на все шансы и быть максимально мобильной; открывать или расширять бизнес; делать упор на коллективную работу; взять ответственность за свою жизнь."
    },
    8: {
        "kontrolnye": "ощущение, что жизнь несправедлива и на тебя навалилось много забот в одночасье; враждебный настрой к миру, обособленность; желание искать источника проблемы вовне; злость и обида по отношению к тем, кому дается все легко; боясь совершить ошибку и разрушить идеальный образ, предпочитаешь бездействие; однобокое мышление, нежелание принимать точку зрения других людей, узколобость; постоянные конфликты, желание других людей вовлечь тебя в ссору, напряжённый спор или обсуждение; череда отвлекающих вопросов, не позволяющих довести до конца важные дела, связанные с семьёй или работой.",
        "strategiya": "делать жизнь понятнее, находить ответы на вопросы; осмысливать свое прошлое и настоящее на предмет, чего ты достигла и к чему хотела бы прийти, каковы твои возможности и насколько ты себя реализуешь в работе, творчестве; прорабатывать отношения с партнером; обращаться к психологу; изучать причинно-следственные связи; поступать с другими так, как хотела бы, чтобы обращались с тобой; проявлять миролюбие, легкое отношение к жизни, при этом работая над своим характером; подружиться со временем; проявлять ответственность; официально оформлять что угодно; действовать в рамках закона; быть внимательной, изучать все договора, а предложения обговаривать на берегу; наводить порядок в делах и документах; систематизировать свою жизнь; отдавать долги; развивать интуицию и шестое чувство; получать юридическое, психологическое или эзотерическое образование."
    },
    9: {
        "kontrolnye": "замкнутость, желание сбежать от мира; ограничения в контактах и общении; ты одинока, и тебя никто не понимает, предложения и идеи подвергаются сомнениям, что вынуждает тебя сомневаться в себе; отказ от материальных благ, ощущение, что нужно сузиться, больше экономить; разочарование в духовных знаниях, мудрости мира; нежелание делиться своим опытом, обесценивание собственного пути; уныние – ощущение бесполезности, безучастности, собственной никчёмности или страха; навязчивость окружающих, когда тебе хочется провести время наедине с собой, но тебя настойчиво вовлекают в общение; советы, вмешательство других и прочие факторы, мешающие развить независимый взгляд.",
        "strategiya": "заниматься наукой, исследованиями; заняться писательством; создавать свои проекты, информационные продукты; брать деньги за свой труд, не отказываться от материального; отказаться от бессмысленной деятельности; обретать мудрость; чаще бывать в уединении, на природе; не прятаться от людей; решать личные (в т.ч. внутренние) задачи; не выступать в качестве спасателя, не навязывать свое мнение; переосмысливать прошлый и настоящий опыт; заниматься поиском смысла жизни и себя в мире; сфокусироваться на своей жизни, реализации, состоянии; заниматься йогой; заниматься творчеством; читать книги по психологии; изучать законы построения взаимоотношений; выстраивать доверительные, более глубокие отношения со спутником жизни, выходя на новый уровень; найти учителя, наставника; стать для кого-то наставником; общаться с бабушками и дедушками; обращаться к внутреннему голосу."
    },
    10: {
        "kontrolnye": "ощущение, что тебе постоянно не везет и успех обходит тебя стороной; ощущение собственной бесполезности из-за лени и бездействия; привычка видеть во всём плохое не дает достичь успеха; завышенные ожидания, которые ввергают тебя в отчаяние; желание закрыться от всего, спад активности, нежелание заводить новые контакты и общаться с людьми; зависть к тем, кто живет в легкости; недоверие миру; столкновений интересов и споры.",
        "strategiya": "верить в себя и высшие силы; жить в потоке, а не по графику и принуждению; благодарить каждый новый день; загадывать желания; ловить знаки судьбы; найти дело по душе; получать удовольствие от жизни; научиться доверять миру; слышать свои потребности и делать выбор в их пользу; вернуть долги, выплатить кредиты; отправляться в спонтанные путешествия; рискнуть и поменять свою жизнь, если есть желание и ты долго это откладывала; уделять внимание общественным связям, общаться с новыми людьми, знакомства, нетворкинг; вести максимально активный образ жизни."
    },
    11: {
        "kontrolnye": "отказ от собственного потенциала и силы; поддаешься внутреннему или внешнему соблазну, страдаешь от последствий; бесцельность, отсутствие чётких намерений, неорганизованность действий; ощущение, что реализоваться в текущих условиях невозможно; чувство, будто силы на исходе и их недостаточно, чтобы сделать прорыв, от этого возрастает напряжение и тревожность, появляется внутренняя агрессия, неуверенность в себе и своих способностях; жестокость суждений – взгляды и мысли подталкивают тебя к поступкам, причиняющим другим боль; пресыщенность, самодовольство – ощущения, которые расслабляют, мешают работать и реализовывать энергию.",
        "strategiya": "учиться управлять своей силой и направлять ее во благо, а не на разрушение и тиранию окружающих; работать над самооценкой; работать над реализацией собственного потенциала; видеть свою силу, найти ее источник (работа с кочуем или системами самопознания); помогать другим людям найти и реализовать потенциал; приводить себя в форму; поддерживать здоровье, энергетические практики, заботиться о слабых."
    },
    12: {
        "kontrolnye": "ощущение, что ты являешься жертвой обстоятельств, что выбраться просто невозможно и ты находишься в подвешенном состоянии; ощущение, что выхода нет, нежелание посмотреть на ситуацию под другим углом; желание страдать, жаловаться; бессилие; принесение себя в жертву ради семьи, прошлого, какой-то идеи; отказы, неудачи, события, не зависящие от тебя и внушающие тебе ощущение безысходности; окружающие могут в грубой форме указывать тебе на ошибки, причиняя душевную боль; чувство отстранённости, ты словно наблюдаешь за жизнью со стороны, не участвуя в ней; гнев и отчаяние препятствуют объективному мышлению.",
        "strategiya": "прислушиваться к себе и присматриваться к тому, что происходит вокруг, следить из какого состояния ты что-то создаешь; становиться в позицию чуткого наблюдателя; выходить из позиции жертвы; творить свою жизнь; выходить из созависимости (любовный интерес, родители, друзья, партнеры по бизнесу); найти человека, которому можно подарить свою любовь от чистого сердца, развивать креативность, помогать людям, ставить интересы на первое место."
    },
    13: {
        "kontrolnye": "ощущение, что все вокруг рушится и ничего не получается, будто привычный мир забирает у тебя, а в новом мире невозможно существовать; ощущение приближающейся беды или апатичность; проблемы в отношениях, делах, на работе, потому что старые концепции уже не работают; желание вцепиться за прошлое, как утопающий за соломинку; расставания, завершение приятного периода жизни, пробуждающее сожаления и негатив; расстроенные планы – события, из-за которых опускаются руки, появляется чувство гнева или подавленности; болезни, плохое самочувствие; ситуации, в которых ты начинаешь всерьёз опасаться за свою жизнь или ментальное здоровье.",
        "strategiya": "принимать изменения, какими бы они ни были; завершить определенный этап в жизни и начать новый; самостоятельно начать отпускать всё старое, ненужное и изжившее себя в это время от работы, отношений, которые уже не устраивают, до вещей (например, заняться расхламлением); искать новые, работающие стратегии; заниматься духовным ростом; научиться отказываться от вредных привычек, пробовать новое."
    },
    14: {
        "kontrolnye": "тревога и беспокойство, напряжение в теле; физическая усталость, слабость, которые ты не можешь контролировать; ощущение, что ты не можешь совмещать все сферы жизни, прийти к балансу, будто в чем-то провисаешь; потеря контакта с собой, жизнь только из головы; принятие решений на эмоциях, разочарование; перепады настроения: от радости к печали, от любви к агрессии; изменчивость и непостоянство, другие люди отменяют и переносят встречи, ведут себя безответственно; сожаления и спешка – чувства, мешающие трезво оценивать свои поступки и слова, порождающие ошибочные решения.",
        "strategiya": "давать себе новые эмоции; идти в духовность, медитировать; находить баланс, ставить цели по всем сферам жизни; слышать свою душу, чего ей хочется; исследовать свой глубинный внутренний мир, учиться быть в гармонии с собой; учиться благодарности, терпению, умеренности, проработать жадность; заниматься творчеством, делами, которые тебе по душе или тем, о чём давно мечтала; тянуться к красоте, искусству, наслаждаться комфортом, доверять жизни, заботиться о теле."
    },
    15: {
        "kontrolnye": "ощущение, что с тебя слишком много требуют и ты постоянно кому-то должна; отсутствие радости, интереса, удовольствий, кажется, что это небезопасно и так неправильно; хочется быть серым и незаметным человеком, спрятаться, чтобы пожить для себя; нежелание проявляться; страх осуждения; неодобрение окружающих, явное осуждение, вызывающее желание противостоять другим людям открыто; отчаяние, вызванное поражением, ты можешь подумать, что тебе нечего терять, и ведешь себя слишком рискованно; желание, преобладающее над разумом, создаётся впечатление, что к цели можно идти любым путём; отсутствие контроля, связи с наставниками, родителями или руководителями, ты ввергаешь свою жизнь в хаос.",
        "strategiya": "научиться говорить нет и отказывать другим; заботиться о себе и своем комфорте; разумно распоряжаться подарками судьбы: не действовать во зло другим, не использовать свое положение и т.д.; быть честной с собой и проявлять свои чувства, эмоции, но работать над этим; заниматься тем, что помогает развивать уверенность, избавляться от зависимостей, брать аскезы, изучать психологию, развивать сексуальность, зарабатывать большие деньги."
    },
    16: {
        "kontrolnye": "потеря всех внешних опор и стабильности; чувство, что мир рушится и жизнь никогда не будет прежней, желание, все сохранить; жалость к себе; страх за будущее; негативное отношение – чувствуя враждебность людей, ты теряешь надежду на успешную жизнь в обществе; привычка преувеличивать масштабы бедствий и мнительность ведут к унынию; находясь в точке стресса, ты принимаешь неверные решения; завышенная самооценка, где считая себя самой талантливой, умной и сильной, ты попадаешь в затруднительное положение.",
        "strategiya": "взращивать внутреннюю опору; видеть события ясно, не накручивать себя; делать то, что можешь с тем, что имеешь прямо сейчас; провести тотальную реконструкцию своей жизни; перестать злиться и жаловаться на тяжелую жизнь; убрать материальные зацепки и привязки (чем большую важность имеет для тебя некий человек или вещь - тем больше шансов их потерять); вводить новые привычки; переосмыслять жизнь и личные ценности, ставить нематериальное на первое место (отношения, семья), изучать психологию, экспериментировать, строить дом."
    },
    17: {
        "kontrolnye": "желание спрятаться и закрыться; ощущение, что сейчас не лучшее время, чтобы проявляться, что твоя ниша уже занята; страх конкуренции, сравнение себя с другими; непринятие своих талантов; страх оценки и зависимость от мнения других; необъективная самооценка, при которой ты считаешь себя самой лучшей или страдаешь от ощущения собственной никчёмности; слова, вводящие в заблуждение – ложь, намеренное искажение истины со стороны других людей; нереальные цели – слишком сложные задачи, которые невозможно выполнить с первого раза; обманутые ожидания и связанные с ними разочарования, вызывающие бессилие.",
        "strategiya": "выходить из тени, обретать славу и публичность (хотя бы на уровне аккаунта в соцсетях или маленького городка); изучать что-то, что поможет повысить экспертность в твоей нише; не бояться использовать возможности; реализовывать свои таланты и самые смелые мечты, становиться примером для остальных; выстраивать границы; нести людям что-то яркое, полезное, интересное, выражая себя, шлифовать навыки, менять имидж, развивать таланты, развивать уверенность, не сравнивать."
    },
    18: {
        "kontrolnye": "всплывают на поверхность страхи, убеждения, блоки, нарастает внутренний конфликт; ощущение, что стресса в жизни слишком много, и ты не можешь с ним справиться; недоверие к миру, кажется, что все вокруг лгут, никому нельзя доверять; желание залечь на дно; бессилие при котором полностью опускаются руки, пропадает инициатива, возникает апатия; отсутствие мыслей, сознание не работает должным образом, нарушается поиск причинно-следственных связей; общение с негативно настроенными людьми, отнимающее последние силы и лишающее объективности; уязвлённое самолюбие, поражающее сердце и разум, мешающее развиваться.",
        "strategiya": "важно не залечь на дно, чтобы спрятаться, а нырнуть в глубины подсознания, чтобы найти там ответы; концентрироваться на личной жизни, саморазвитии, обустройстве дома; наводить порядок в доме и заниматься его благоустройством; уделять внимание своей подсознательной стороне личности; прислушиваться к себе и действовать по своим желаниям; налаживать контакт с матерью, позитивно мыслить, медитировать, избавляться от страхов, развивать интуицию."
    },
    19: {
        "kontrolnye": "ощущение, что ты на нуле, не хватает энергии; действия не приносят ожидаемого результата; потеря радости, любви к жизни, действия на автопилоте; нет сил и энергии для реализации; сжигание себя неуверенностью, сомнениями, агрессией, хочется срываться на окружающих, будто в них корень проблем; нестабильность, которая лишает тебя покоя, мешает сосредотачиваться на своих целях; страхи, которые внушают окружающие люди; холодность и отчуждение, разрыв отношений, ощущение изолированности, когда между тобой и обществом выстраивается стена; помощь, которую ты предлагаешь другим, оказывается ненужной или бесполезной.",
        "strategiya": "наслаждаться простыми радостями; баловать своего внутреннего ребёнка, добирать то, чего не доставало в детстве; контактировать с детьми; выстраивать отношения с братьями или сестрами, если они долгое время не были близкими; чаще благодарить жизнь за то, что она даёт; давать больше свободы детям; плавно распределять энергию на самые разные сферы жизни, уделяя внимание реализации, не растрачивать энергию, мотивировать окружение, искать вдохновение, зарабатывать."
    },
    20: {
        "kontrolnye": "давление со стороны; ощущение, что ты свернула не туда, и твои родители были правы; зависимость от родителей, желание получить их одобрение; потеря статуса и авторитета; напряжение в семье; попадание под влияние социума и рода; окружающие люди будут вкладывать в твой разум свои страхи, манипулировать сознанием; все мысли, и действия не будут иметь единого центра и смысла; если ты привыкла следовать определённому порядку, то тебя могут сбить с толку неожиданные события; в твои дела то и дело вмешиваются третьи лица.",
        "strategiya": "налаживать связи с членами рода, особенно с родителями; объединять семью, искать потерянных родственников, собираться с родственниками, общаться со старшими членами рода, помогать родственникам; выявить и проработать негативные сценарии рода, не повторять их ошибки; прорабатывать обиды на родителей, убирать претензии; узнавать историю семьи и составлять генеалогическое древо; выяснить что важно в этой жизни для тебя в каждой сфере; поверить в себя, создавать системы, развивать бизнес, позитивное мышление, изучать законы мироздания."
    },
    21: {
        "kontrolnye": "ощущение, что возможности отсутствуют; страх идти в новое и развиваться; негатив к инакомыслящим; чувство разделения, враждебность; страх идти в расширение и масштаб; чувство, будто произошел сбой и обновление не загружается в ваше сознание; отсутствие согласия – осуждение со стороны родителей или друзей, чувство отверженности; испытываешь желание отказаться от дела, даже не попробовав свои силы; ошибочная информация, которая станет причиной серьёзных ошибок, внушающих неуверенность в себе; негативные известия от друзей или родных, которые пробудят желание закрыться от всего мира и углубиться в свои переживания.",
        "strategiya": "путешествовать по миру, посещать города и страны, общаться с иностранцами, исследовать культуру и традиции других стран; изучать языки; ехать работать/жить за границу; выходить за рамки ограничивающих убеждений, мыслить глобально, масштабно, изучать новые подходы; создавать и продвигать интернет-проекты; заводить новые контакты и полезные связи; жить в мире, быть миротворцем, объединять людей, заниматься глобальными проектами, благодарить."
    },
    22: {
        "kontrolnye": "чувство, будто ты находишься в клетке и не можешь ни на что повлиять; желание не брать ответственность и ни о чем не задумываться, плыть по течению; детская позиция; потеря легкости и интереса к происходящему; желание заглушить внутреннюю несвободу через мнимые удовольствия; давление общества, стремящегося заключить тебя в рамки и стандарты; ограниченность в финансах и материальных ресурсах; недостаток физических сил; сильная боль из-за обманутых ожиданий или неудач; ложь, затягивающая тебя в паутину фальши, притворства и недоверия.",
        "strategiya": "брать ответственность за свою жизнь; действовать в том месте и обстоятельствах, в которых ты находишься сейчас; жить беззаботно и относиться ко всему происходящему легко и с юмором; настраивать себя позитивно, уметь замечать хорошее в мелочах, больше радоваться, быть свободной; радовать себя; спокойно менять то, что себя отжило; жить в потоке и наслаждаться состоянием здесь и сейчас; чувствовать себя свободно в любых условиях; давать себе реализовывать желания, путешествовать, вступать в партнерство, планировать зачатие ребенка."
    }
}


# --- Логирование ---
class UserFilter(logging.Filter):
    def filter(self, record):
        record.user_id_log = getattr(record, 'user_id', 'SYSTEM')
        return True


class CustomFormatter(logging.Formatter):
    def format(self, record):
        user_prefix = f"[{record.user_id_log}]"
        return f"{user_prefix} {super().format(record)}"


logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)
file_handler = logging.FileHandler("bot.log", encoding='utf-8')
file_handler.setFormatter(CustomFormatter(fmt="{asctime} - {levelname} - {message}", style='{'))
logger.addHandler(file_handler)
logger.addFilter(UserFilter())


# --- Функция проверки подписки ---
async def check_subscription(user_id: int) -> bool:
    """Проверяет подписан ли пользователь на канал"""
    try:
        chat_member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        is_subscribed = chat_member.status in ["member", "administrator", "creator"]
        logger.info(f"Subscription check: {is_subscribed}", extra={'user_id': user_id})
        return is_subscribed
    except TelegramUnauthorizedError:
        logger.error(f"Bot cannot access channel {CHANNEL_ID}", extra={'user_id': user_id})
        return False
    except TelegramBadRequest as e:
        logger.error(f"Bad request during subscription check: {e}", extra={'user_id': user_id})
        return False
    except Exception as e:
        logger.error(f"Unexpected error during subscription check: {e}", extra={'user_id': user_id})
        return False


# --- Функции данных ---
async def load_data():
    global user_profiles, user_actions_log, statistics
    try:
        if os.path.exists(USER_DATA_FILE):
            async with aiofiles.open(USER_DATA_FILE, 'r', encoding='utf-8') as f:
                user_profiles = {int(k): v for k, v in json.loads(await f.read()).items()}
        if os.path.exists(ACTIONS_LOG_FILE):
            async with aiofiles.open(ACTIONS_LOG_FILE, 'r', encoding='utf-8') as f:
                user_actions_log = json.loads(await f.read())
        if os.path.exists(STATISTICS_FILE):
            async with aiofiles.open(STATISTICS_FILE, 'r', encoding='utf-8') as f:
                loaded = json.loads(await f.read())
                statistics.update(loaded)
                if 'date_frequency' in loaded:
                    statistics['date_frequency'] = defaultdict(int, loaded['date_frequency'])
    except Exception as e:
        logger.error(f"Load error: {e}", extra={'user_id': 'SYSTEM'})


async def save_data():
    async with save_lock:
        try:
            async with aiofiles.open(USER_DATA_FILE, 'w', encoding='utf-8') as f:
                await f.write(json.dumps(user_profiles, ensure_ascii=False, indent=2))
            async with aiofiles.open(ACTIONS_LOG_FILE, 'w', encoding='utf-8') as f:
                await f.write(json.dumps(user_actions_log[-10000:], ensure_ascii=False, indent=2))
            stats = statistics.copy()
            stats['date_frequency'] = dict(statistics['date_frequency'])
            async with aiofiles.open(STATISTICS_FILE, 'w', encoding='utf-8') as f:
                await f.write(json.dumps(stats, ensure_ascii=False, indent=2))
        except Exception as e:
            logger.error(f"Save error: {e}", extra={'user_id': 'SYSTEM'})


async def periodic_save():
    while True:
        await asyncio.sleep(300)
        await save_data()


def get_user_info(obj):
    try:
        user = obj.from_user if hasattr(obj, 'from_user') else obj
        return user.id, user.username or "нет", user.first_name or "Без имени"
    except:
        return 0, "unknown", "unknown"


def log_user_action(user_id: int, action: str, extra: str = ""):
    global statistics, session_messages_count
    try:
        statistics['total_messages'] += 1
        session_messages_count += 1
        user_actions_log.append({
            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'user_id': user_id,
            'action': action,
            'extra_info': extra
        })
        if len(user_actions_log) > 10000:
            user_actions_log.pop(0)
        logger.info(f"{action} | {extra}" if extra else action, extra={'user_id': user_id})
    except Exception as e:
        logger.error(f"Log error: {e}", extra={'user_id': user_id})


async def update_user_profile(user_id, username, first_name):
    try:
        now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        if user_id not in user_profiles:
            user_profiles[user_id] = {
                'id': user_id, 'first_name': first_name, 'username': username,
                'first_seen': now, 'last_seen': now, 'total_interactions': 1,
                'calculations_count': 0, 'month_calculations': 0, 'year_calculations': 0
            }
        else:
            user_profiles[user_id].update({
                'first_name': first_name, 'username': username, 'last_seen': now,
                'total_interactions': user_profiles[user_id].get('total_interactions', 0) + 1
            })
    except Exception as e:
        logger.error(f"Profile update error: {e}", extra={'user_id': user_id})


def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_USER_IDS


def reduce_to_arcana(num: int) -> int:
    """Сворачивает число до аркана (до 22 или меньше)"""
    while num > 22:
        num = sum(int(d) for d in str(num))
    return num


def calculate_year_control(birth_date: str, target_year: int) -> tuple:
    """Расчет прогноза на год"""
    try:
        birth_year = int(birth_date.split('.')[2])
        year_sum = sum(int(d) for d in str(birth_year))
        while year_sum > 22:
            year_sum = sum(int(d) for d in str(year_sum))
        target_sum = sum(int(d) for d in str(target_year))
        while target_sum > 22:
            target_sum = sum(int(d) for d in str(target_sum))
        control = year_sum + target_sum
        if control > 22:
            control = sum(int(d) for d in str(control))
        return control, year_sum, target_sum
    except Exception as e:
        logger.error(f"Calc error: {e}")
        raise


def calculate_month_prediction(birth_date: str, target_year: int, target_month: int) -> tuple:
    """Расчет прогноза на месяц"""
    try:
        parts = birth_date.split('.')
        day = int(parts[0])
        month = int(parts[1])

        step1 = day + month
        uchg = sum(int(d) for d in str(target_year))
        uchm = target_month
        result = step1 + uchg + uchm
        result = reduce_to_arcana(result)

        return result, step1, uchg, uchm
    except Exception as e:
        logger.error(f"Month calc error: {e}")
        raise


def validate_date(date_input: str) -> tuple:
    try:
        nums = re.findall(r'\d+', date_input)
        if len(nums) != 3:
            return False, "❌ Формат: ДД.ММ.ГГГГ (например, 10.10.2000)"
        day_str, month_str, year_str = nums
        if len(year_str) != 4:
            return False, "❌ Год из 4 цифр (например, 2000)"
        day, month, year = int(day_str), int(month_str), int(year_str)
        if day < 1 or day > 31 or month < 1 or month > 12:
            return False, "❌ Неверный день или месяц"
        parsed = datetime(year, month, day).date()
        if parsed > date.today():
            return False, "🤔 Дата не может быть в будущем!"
        age = date.today().year - year
        if age > 120:
            return False, "😲 Вам не может быть больше 120 лет!"
        return True, parsed.strftime("%d.%m.%Y")
    except ValueError:
        return False, "❌ Некорректная дата"
    except:
        return False, "❌ Ошибка валидации"


def validate_year(year_input: str) -> tuple:
    try:
        year = int(year_input.strip())
        current = datetime.now().year
        if year < 1900:
            return False, "❌ Год слишком далеко в прошлом"
        if year > current + 100:
            return False, "❌ Год слишком далеко в будущем"
        return True, year
    except ValueError:
        return False, "❌ Введите год числом (например, 2025)"
    except:
        return False, "❌ Ошибка валидации года"


# --- Клавиатуры ---
def create_subscription_keyboard():
    """Клавиатура для подписки на канал"""
    builder = InlineKeyboardBuilder()
    builder.button(text="📢 Подписаться на канал", url=CHANNEL_LINK)
    builder.button(text="✅ Я подписался", callback_data="check_subscription")
    builder.adjust(1)
    return builder.as_markup()


def create_prediction_type_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="📅 Прогноз на месяц", callback_data="type_month")
    builder.button(text="📆 Прогноз на год", callback_data="type_year")
    builder.adjust(1)
    return builder.as_markup()


def create_agree_type_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="Да", callback_data="agree_yes")
    builder.button(text="Нет", callback_data="agree_no")
    builder.adjust(1)
    return builder.as_markup()


def create_month_keyboard():
    builder = InlineKeyboardBuilder()
    for month_num, month_name in MONTH_NAMES.items():
        builder.button(text=f"{month_name}", callback_data=f"month_{month_num}")
    builder.adjust(3)
    return builder.as_markup()


def create_confirmation_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="✅ Да", callback_data="confirm_yes")
    builder.button(text="❌ Нет", callback_data="confirm_no")
    builder.adjust(2)
    return builder.as_markup()


def create_restart_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="🔄 Сделать новый расчет", callback_data="restart_new")
    builder.adjust(1)
    return builder.as_markup()


def create_zapis_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="💬 Записаться", url="https://t.me/esotericdigits")
    builder.adjust(1)
    return builder.as_markup()


# --- FSM ---
class UserStates(StatesGroup):
    checking_subscription = State()
    choosing_type = State()
    asking_for_consent = State()
    waiting_for_date = State()
    waiting_for_year = State()
    waiting_for_month = State()
    waiting_for_confirmation = State()
    waiting_for_new_date = State()


bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()


# --- Команды ---
@dp.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)
        await state.clear()
        log_user_action(user_id, "START", f"@{username}")

        # Приветствие
        await message.answer(
            f"👋 Привет, {first_name}!\n\n"
            f"Добро пожаловать в мой бот расчёта прогнозов по дате рождения. Я помогу узнать, что Вас ждёт в будущем и подготовиться к сложностям. Это поможет понять, как вам действовать  и найти пути для гармоничных условий проживания периода.\n\n"
            f"Мой бот поможет вам увидеть сильные стороны вашего сознания, а также области, которые могут стать источником конфликтов. Получив эту информацию, вы сможете сделать свою жизнь  гармоничнее и счастливее!!\n"
        )

        await asyncio.sleep(8)

        photo = FSInputFile(MONTH_PHOTOS_DIR / f"I.jpg")
        await message.answer_photo(photo)

        await message.answer(
            f"Я Бубиго Анастасия — цифровой психолог. \n\nПомогаю создать и удержать состояние, которое улучшает качество жизни через матрицу судьбы, цифровую психологию, уровень энергии.\n\n"
            f"Моя миссия: Помогать и раскрывать потенциал каждого, кто со мной соприкасается и помогать проживать свою жизнь в состоянии счастливого человека. Когда вы понимаете свои чувства, эмоции, принимаете таланты, уважаете и понимаете свой род и его силу, идете по пути своей миссии и понимаете в чем ваше предназначение в этом 🌍 мире.\n\n"
            f"Мой метод консультирования основан на знаниях: \n\n"
            f"🟣 Ведическая нумерология \n"
            f"🟣 Матрица судьбы \n"
            f"🟣 Энергокоучинг и энерготерапия по методу психопортрет личности \n"
            f"🟣 Цифровая психология.\n"
            f"Я рада знакомству с каждым из вас!\n"
        )

        await asyncio.sleep(7)

        await message.answer(
            f"🆘 Подтвердите обработку персональных данных.\n",
            reply_markup=create_agree_type_keyboard()
        )

        await state.set_state(UserStates.asking_for_consent)

    except Exception as e:
        logger.error(f"Start error: {e}", extra={'user_id': 0})
        await message.answer("❌ Ошибка. Попробуйте позже.")


@dp.callback_query(lambda c: c.data == "check_subscription")
async def process_subscription_check(callback: CallbackQuery, state: FSMContext):
    """Проверка подписки после нажатия кнопки"""
    try:
        user_id, username, first_name = get_user_info(callback)
        await update_user_profile(user_id, username, first_name)

        is_subscribed = await check_subscription(user_id)

        if is_subscribed:
            await callback.answer("✅ Подписка подтверждена!", show_alert=False)
            await callback.message.edit_text(
                "✅ Отлично! Подписка подтверждена.\n\n"
                "Выберите тип прогноза:",
                reply_markup=create_prediction_type_keyboard()
            )
            await state.set_state(UserStates.choosing_type)
            log_user_action(user_id, "SUBSCRIPTION_CONFIRMED")
        else:
            await callback.answer(
                "❌ Подписка не найдена. Пожалуйста, подпишитесь на канал и попробуйте снова.",
                show_alert=True
            )
            log_user_action(user_id, "SUBSCRIPTION_NOT_FOUND")

    except Exception as e:
        logger.error(f"Subscription check error: {e}", extra={'user_id': 0})
        await callback.answer("❌ Ошибка проверки подписки", show_alert=True)


@dp.message(Command("statistic"))
async def cmd_statistic(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)
        log_user_action(user_id, "STATISTIC")

        if not is_admin(user_id):
            await message.answer("❌ Команда только для администраторов")
            return

        # Проверка подписки для админов
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для использования бота необходимо подписаться на наш канал.",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        uptime = datetime.now() - datetime.fromisoformat(statistics['session_start_time'])
        h, rem = divmod(int(uptime.total_seconds()), 3600)
        m, s = divmod(rem, 60)

        sorted_users = sorted(
            user_profiles.items(),
            key=lambda x: x[1].get('total_interactions', 0),
            reverse=True
        )[:3]

        top = "\n".join([
            f"{i + 1}. @{u[1]['username']} - {u[1].get('total_interactions', 0)} действий"
            for i, u in enumerate(sorted_users)
        ]) or "Нет данных"

        await message.answer(
            f"📊 **Статистика бота**\n\n"
            f"👥 Всего пользователей: {len(user_profiles)}\n"
            f"📥 Всего действий: {statistics['total_messages']}\n"
            f"🔢 Всего расчетов: {statistics['total_calculations']}\n"
            f"📅 Расчетов на месяц: {statistics.get('total_month_calculations', 0)}\n"
            f"📆 Расчетов на год: {statistics.get('total_year_calculations', 0)}\n"
            f"📥 Действий в сеансе: {session_messages_count}\n"
            f"⏱ Время работы: {h}ч {m}м {s}с\n\n"
            f"🏆 **Топ пользователей:**\n{top}"
        )
    except Exception as e:
        logger.error(f"Stat error: {e}", extra={'user_id': user_id})


@dp.message(Command("statisticplus"))
async def cmd_statistic_plus(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)
        log_user_action(user_id, "DETAILED_STAT")

        if not is_admin(user_id):
            await message.answer("❌ Команда только для администраторов")
            return

        # Проверка подписки для админов
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для использования бота необходимо подписаться на наш канал.",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        await save_data()

        profiles = "ID | Имя | Username | Первый | Последний | Действия | Расчеты (месяц/год)\n" + "=" * 120 + "\n"
        for uid, p in user_profiles.items():
            month_calc = p.get('month_calculations', 0)
            year_calc = p.get('year_calculations', 0)
            profiles += f"{p['id']} | {p['first_name']} | @{p['username']} | {p['first_seen']} | {p['last_seen']} | {p.get('total_interactions', 0)} | {month_calc}/{year_calc}\n"

        actions = "Последние действия:\n" + "=" * 100 + "\n"
        for a in user_actions_log[-1000:]:
            actions += f"[{a['timestamp']}] USER_{a['user_id']}: {a['action']} {a['extra_info']}\n"

        await message.answer_document(
            BufferedInputFile(profiles.encode('utf-8'),
                              filename=f"profiles_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"),
            caption="📊 Профили"
        )
        await message.answer_document(
            BufferedInputFile(actions.encode('utf-8'),
                              filename=f"actions_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"),
            caption="📝 Действия"
        )
    except Exception as e:
        logger.error(f"StatPlus error: {e}", extra={'user_id': user_id})


# --- Callbacks ---
@dp.callback_query(lambda c: c.data in ["agree_yes", "agree_no"], UserStates.asking_for_consent)
async def process_consent_choice(callback: CallbackQuery, state: FSMContext):
    user_id, username, first_name = get_user_info(callback)
    await callback.answer()  # Убирает "часики" с кнопки

    if callback.data == "agree_yes":
        log_user_action(user_id, "CONSENT_GIVEN")
        await callback.message.edit_text(
            "✅ Спасибо за Ваше согласие! Продолжаем работу."
        )

        # Логика проверки подписки (теперь только здесь)
        is_subscribed = await check_subscription(user_id)

        if is_subscribed:
            await callback.message.answer(  # Изменено на .answer, чтобы не редактировать предыдущее
                "✅ Отлично! Вы уже подписаны на наш канал.\n\n"
                "Выберите тип прогноза:",
                reply_markup=create_prediction_type_keyboard()
            )
            await state.set_state(UserStates.choosing_type)
        else:
            await callback.message.answer(  # Изменено на .answer
                "📢 Для использования бота необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)

    elif callback.data == "agree_no":
        log_user_action(user_id, "CONSENT_DENIED")

        # Повторный запрос: Пользователь остается в состоянии asking_for_consent
        await callback.message.edit_text(
            "❌ **ВНИМАНИЕ:** Без Вашего согласия на обработку данных, мы не можем предоставить Вам расчеты.\n\n"
            "Если Вы передумаете, пожалуйста, подтвердите согласие, чтобы начать работу:",
            reply_markup=create_agree_type_keyboard()  # Повторно отправляем кнопки
        )
        # Состояние остается UserStates.asking_for_consent, ожидая 'agree_yes'.

    else:
        await callback.message.edit_text("Неизвестный выбор. Попробуйте /start")
        await state.clear()


@dp.callback_query(lambda c: c.data in ['type_month', 'type_year'])
async def process_type_choice(callback: CallbackQuery, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(callback)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки перед каждым действием
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await callback.answer(
                "❌ Подписка не найдена. Пожалуйста, подпишитесь на канал.",
                show_alert=True
            )
            await callback.message.edit_text(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        await callback.answer()

        prediction_type = "month" if callback.data == "type_month" else "year"
        await state.update_data(prediction_type=prediction_type)

        log_user_action(user_id, f"TYPE_SELECTED", prediction_type)

        type_text = "на месяц 📅" if prediction_type == "month" else "на год 📆"
        await callback.message.answer(
            f"✅ Выбран прогноз {type_text}\n\n"
            f"📅 Введите вашу дату рождения\n\n"
            f"Формат: ДД.ММ.ГГГГ\n"
            f"Пример: 18.12.1999"
        )
        await state.set_state(UserStates.waiting_for_date)
    except Exception as e:
        logger.error(f"Type choice error: {e}", extra={'user_id': 0})


@dp.callback_query(lambda c: c.data.startswith('month_'))
async def process_month_choice(callback: CallbackQuery, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(callback)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await callback.answer(
                "❌ Подписка не найдена. Пожалуйста, подпишитесь на канал.",
                show_alert=True
            )
            await callback.message.answer(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        await callback.answer()

        month_num = int(callback.data.split('_')[1])
        await state.update_data(target_month=month_num)

        log_user_action(user_id, "MONTH_SELECTED", MONTH_NAMES[month_num])

        data = await state.get_data()
        birth_date = data.get('user_date')
        target_year = data.get('target_year')

        await callback.message.answer(
            f"✅ Данные для расчета:\n\n"
            f"📅 Дата рождения: {birth_date}\n"
            f"📆 Год: {target_year}\n"
            f"📅 Месяц: {MONTH_NAMES[month_num]}\n\n"
            f"Все верно?",
            reply_markup=create_confirmation_keyboard()
        )
        await state.set_state(UserStates.waiting_for_confirmation)

    except Exception as e:
        logger.error(f"Month choice error: {e}", extra={'user_id': user_id})


@dp.callback_query(lambda c: c.data in ['confirm_yes', 'confirm_no'])
async def process_confirmation(callback: CallbackQuery, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(callback)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await callback.answer(
                "❌ Подписка не найдена. Пожалуйста, подпишитесь на канал.",
                show_alert=True
            )
            await callback.message.answer(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        await callback.answer()

        if callback.data == 'confirm_yes':
            log_user_action(user_id, "CONFIRMED")

            data = await state.get_data()
            birth_date = data.get('user_date')
            target_year = data.get('target_year')
            prediction_type = data.get('prediction_type', 'year')

            if not birth_date or not target_year:
                await callback.message.answer("❌ Ошибка. Начните с /start")
                await state.clear()
                return

            statistics['total_calculations'] += 1
            if user_id in user_profiles:
                user_profiles[user_id]['calculations_count'] = user_profiles[user_id].get('calculations_count', 0) + 1

            if prediction_type == 'month':
                target_month = data.get('target_month')
                if not target_month:
                    await callback.message.answer("❌ Ошибка. Начните с /start")
                    await state.clear()
                    return

                result, step1, uchg, uchm = calculate_month_prediction(birth_date, target_year, target_month)

                statistics['total_month_calculations'] = statistics.get('total_month_calculations', 0) + 1
                if user_id in user_profiles:
                    user_profiles[user_id]['month_calculations'] = user_profiles[user_id].get('month_calculations',
                                                                                              0) + 1

                log_user_action(user_id, "MONTH_CALC_DONE", f"{birth_date} + {target_year}/{target_month} = {result}")

                parts = birth_date.split('.')
                day = int(parts[0])
                if (day > 22):
                    day = sum(int(d) for d in str(day))

                photo_path = MONTH_PHOTOS_DIR / f"Прогноз Месяца_{result}.jpg"
                photo2_path = MONTH_PHOTOS_DIR / f"Основная энергия_{day}.jpg"

                if photo_path.exists():
                    try:
                        photo = FSInputFile(photo_path)
                        await callback.message.answer_document(
                            document=photo,
                            caption=f"🔮 Прогноз на {MONTH_NAMES[target_month]} {target_year}\n\n📥 Скачайте изображение"
                        )
                        logger.info(f"Photo sent as document: {photo_path}", extra={'user_id': user_id})
                    except Exception as e:
                        logger.error(f"Photo send error: {e}", extra={'user_id': user_id})
                        await callback.message.answer("⚠️ Не удалось отправить изображение. Проверьте логи.")
                else:
                    logger.warning(f"Photo not found: {photo_path}", extra={'user_id': user_id})
                    await callback.message.answer(f"⚠️ Изображение для прогноза ({photo_path.name}) не найдено.")
                await asyncio.sleep(15)
                caption = (
                    f"⭕️А теперь давай узнаем о чем говорит Ваша визитная карточка сознания."
                )

                if photo2_path.exists():
                    try:
                        await callback.message.answer(
                            caption,
                            # reply_markup=create_restart_keyboard()
                        )
                        photo = FSInputFile(photo2_path)
                        await callback.message.answer_document(
                            document=photo,
                            caption=f"🔮 Ваш портрет личности или о чем говорит ваше подсознание\n\n📥 Скачайте изображение",
                            reply_markup=create_restart_keyboard()
                        )
                        logger.info(f"Photo sent as document: {photo2_path}", extra={'user_id': user_id})
                    except Exception as e:
                        await callback.message.answer(
                            caption,
                            reply_markup=create_restart_keyboard()
                        )
                        logger.error(f"Photo send error: {e}", extra={'user_id': user_id})
                        await callback.message.answer("⚠️ Не удалось отправить изображение. Проверьте логи.")
                else:
                    logger.warning(f"Photo not found: {photo2_path}", extra={'user_id': user_id})
                    await callback.message.answer(f"⚠️ Изображение для прогноза ({photo2_path.name}) не найдено.")
                await asyncio.sleep(15)
                await callback.message.answer(
                    f"""✨

Если хотите узнать себя получше, записывайтесь на личную консультацию! 

---------------------------

Ценность тарифов:

🛒 "Портрет Личности", который станет вашей личной инструкцией к жизни!

"Портрет Личности" — поможет :
• Понять свои сильные и слабые стороны
• Узнать о своих жизненных целях и предназначении
• Открыть секреты гармонии в отношениях
• Получить рекомендации по карьерному росту и самореализации
- Рекомендации как действовать, что планировать 
- Финансовый код 
- Инструменты к применению 

250 BYN/ 85$ / 7 000 RUB

----------------------------

🛒 Финансовый код и расчет денежного потенциала

- Финансовые отношения с деньгами 
- Что блокирует финансовые возможности 
-куда утекают 💴 деньги 
-На что тратит, чтобы получать больше
-Какие профессии выбрать 
-Какие таланты развить, для денежного потенциала 
-КОД вашей активации денежных потоков 

59 BYN/ 15$ / 1 200 RUB


---------------------------

🛒 VIP - Семейная консультация, с влиянием окружения: 

- Как вас видят окружение(детско-родительские отношения)
- Ваша зона комфорта и наполнения
- Как построить гармоничные отношения 
- Какие проблемы в отношениях могут быть
- Как найти своего человека
- Что для вас значит быть в партнерстве
- Рекомендации как действовать, что планировать 
- Финансовые пути реализации для пары

300 BYN/ 8 200 RUB

----------------------------

⏱ , давай забронируем время для консультации!""",
                    reply_markup=create_zapis_keyboard()
                )



            else:

                control, year_sum, target_sum = calculate_year_control(birth_date, target_year)

                statistics['total_year_calculations'] = statistics.get('total_year_calculations', 0) + 1
                if user_id in user_profiles:
                    user_profiles[user_id]['year_calculations'] = user_profiles[user_id].get('year_calculations', 0) + 1

                log_user_action(user_id, "YEAR_CALC_DONE", f"{birth_date} + {target_year} = {control}")

                result_text = f"🔮 **Расчет для {birth_date} на {target_year} год**\n\n"
                result_text += f"📊 Личный аркан года: {year_sum}\n"
                result_text += f"📊 Аркан года {target_year}: {target_sum}\n"
                result_text += f"🎯 **Контрольная работа: ЭНЕРГИЯ {control}**\n\n"

                if control in KONTROLNYE_TEXTY:
                    texts = KONTROLNYE_TEXTY[control]
                    result_text += f"⚠️ **Контрольные работы:**\n{texts['kontrolnye']}\n\n"
                    result_text += f"✅ **Стратегия действий:**\n{texts['strategiya']}"
                else:
                    result_text += f"ℹ️ Информация для энергии {control} добавляется..."

                await callback.message.answer(result_text)
                await asyncio.sleep(15)
                await callback.message.answer(f"⭕️А теперь давай узнаем о чем говорит Ваша визитная карточка сознания.")

                parts = birth_date.split('.')
                day = int(parts[0])
                if (day > 22):
                    day = sum(int(d) for d in str(day))
                photo2_path = MONTH_PHOTOS_DIR / f"Основная энергия_{day}.jpg"
                if photo2_path.exists():
                    try:
                        photo = FSInputFile(photo2_path)
                        await callback.message.answer_document(
                            document=photo,
                            caption=f"🔮 Ваш портрет личности или о чем говорит ваше подсознание\n\n📥 Скачайте изображение",
                            reply_markup=create_restart_keyboard()
                        )
                        logger.info(f"Photo sent as document: {photo2_path}", extra={'user_id': user_id})
                    except Exception as e:
                        logger.error(f"Photo send error: {e}", extra={'user_id': user_id})
                        await callback.message.answer("⚠️ Не удалось отправить изображение. Проверьте логи.")
                else:
                    logger.warning(f"Photo not found: {photo2_path}", extra={'user_id': user_id})
                    await callback.message.answer(f"⚠️ Изображение для прогноза ({photo2_path.name}) не найдено.")
                await asyncio.sleep(15)
                await callback.message.answer(
                    f"""✨

                Если хотите узнать себя получше, записывайтесь на личную консультацию! 

                ---------------------------

                Ценность тарифов:

                🛒 "Портрет Личности", который станет вашей личной инструкцией к жизни!

                "Портрет Личности" — поможет :
                • Понять свои сильные и слабые стороны
                • Узнать о своих жизненных целях и предназначении
                • Открыть секреты гармонии в отношениях
                • Получить рекомендации по карьерному росту и самореализации
                - Рекомендации как действовать, что планировать 
                - Финансовый код 
                - Инструменты к применению 

                250 BYN/ 85$ / 7 000 RUB

                ----------------------------

                🛒 Финансовый код и расчет денежного потенциала

                - Финансовые отношения с деньгами 
                - Что блокирует финансовые возможности 
                -куда утекают 💴 деньги 
                -На что тратит, чтобы получать больше
                -Какие профессии выбрать 
                -Какие таланты развить, для денежного потенциала 
                -КОД вашей активации денежных потоков 

                59 BYN/ 15$ / 1 200 RUB


                ---------------------------

                🛒 VIP - Семейная консультация, с влиянием окружения: 

                - Как вас видят окружение(детско-родительские отношения)
                - Ваша зона комфорта и наполнения
                - Как построить гармоничные отношения 
                - Какие проблемы в отношениях могут быть
                - Как найти своего человека
                - Что для вас значит быть в партнерстве
                - Рекомендации как действовать, что планировать 
                - Финансовые пути реализации для пары

                300 BYN/ 8 200 RUB

                ----------------------------

                ⏱ , давай забронируем время для консультации!""",
                    reply_markup=create_zapis_keyboard()
                )

            await state.set_state(UserStates.waiting_for_new_date)

        else:
            log_user_action(user_id, "CANCELLED")
            await callback.message.answer(
                "❌ Ввод отменен\n\nНажмите кнопку ниже для нового расчета",
                reply_markup=create_restart_keyboard()
            )
            await state.set_state(UserStates.waiting_for_new_date)

    except Exception as e:
        logger.error(f"Confirm error: {e}", extra={'user_id': user_id})
        await callback.message.answer("❌ Ошибка. Начните с /start")
        await state.clear()


@dp.callback_query(lambda c: c.data == 'restart_new')
async def process_restart(callback: CallbackQuery, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(callback)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await callback.answer(
                "❌ Подписка не найдена. Пожалуйста, подпишитесь на канал.",
                show_alert=True
            )
            await callback.message.edit_text(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        await callback.answer()
        log_user_action(user_id, "RESTART")

        await callback.message.answer(
            "🔮 Выберите тип прогноза:",
            reply_markup=create_prediction_type_keyboard()
        )
        await state.set_state(UserStates.choosing_type)
    except Exception as e:
        logger.error(f"Restart error: {e}", extra={'user_id': 0})


# --- Обработчики сообщений ---
@dp.message(UserStates.waiting_for_date)
async def process_date(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        date_input = message.text.strip()
        log_user_action(user_id, "DATE_INPUT", date_input)

        is_valid, result = validate_date(date_input)

        if not is_valid:
            log_user_action(user_id, "INVALID_DATE", date_input)
            await message.answer(result)
            return

        normalized_date = result
        await state.update_data(user_date=normalized_date)
        log_user_action(user_id, "DATE_VALID", normalized_date)

        await message.answer(
            f"✅ Дата принята: {normalized_date}\n\n"
            f"📆 Теперь введите год для расчета\n"
            f"Пример: 2025"
        )
        await state.set_state(UserStates.waiting_for_year)

    except Exception as e:
        logger.error(f"Date process error: {e}", extra={'user_id': user_id})
        await message.answer("❌ Ошибка. Попробуйте еще раз")


@dp.message(UserStates.waiting_for_year)
async def process_year(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        year_input = message.text.strip()
        log_user_action(user_id, "YEAR_INPUT", year_input)

        is_valid, result = validate_year(year_input)

        if not is_valid:
            log_user_action(user_id, "INVALID_YEAR", year_input)
            await message.answer(result)
            return

        target_year = result
        await state.update_data(target_year=target_year)
        log_user_action(user_id, "YEAR_VALID", str(target_year))

        data = await state.get_data()
        prediction_type = data.get('prediction_type', 'year')

        if prediction_type == 'month':
            await message.answer(
                f"✅ Год принят: {target_year}\n\n"
                f"📅 Теперь выберите месяц:",
                reply_markup=create_month_keyboard()
            )
            await state.set_state(UserStates.waiting_for_month)

        else:
            birth_date = data.get('user_date')
            await message.answer(
                f"✅ Данные для расчета:\n\n"
                f"📅 Дата рождения: {birth_date}\n"
                f"📆 Целевой год: {target_year}\n\n"
                f"Все верно?",
                reply_markup=create_confirmation_keyboard()
            )
            await state.set_state(UserStates.waiting_for_confirmation)

    except Exception as e:
        logger.error(f"Year process error: {e}", extra={'user_id': user_id})
        await message.answer("❌ Ошибка. Попробуйте еще раз")


@dp.message(UserStates.waiting_for_new_date)
async def handle_new_date_state(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для продолжения работы необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        log_user_action(user_id, "MSG_IN_NEW_STATE")

        await message.answer(
            "👇 Используйте кнопки ниже:",
            reply_markup=create_restart_keyboard()
        )
    except Exception as e:
        logger.error(f"New state error: {e}", extra={'user_id': 0})


@dp.message(UserStates.checking_subscription)
async def handle_subscription_state(message: Message, state: FSMContext):
    """Обработка сообщений в состоянии проверки подписки"""
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)

        await message.answer(
            "📢 Пожалуйста, используйте кнопки для подписки и проверки.\n\n"
            "После подписки нажмите '✅ Я подписался'",
            reply_markup=create_subscription_keyboard()
        )
    except Exception as e:
        logger.error(f"Subscription state error: {e}", extra={'user_id': 0})


@dp.message()
async def handle_other(message: Message, state: FSMContext):
    try:
        user_id, username, first_name = get_user_info(message)
        await update_user_profile(user_id, username, first_name)

        # Проверка подписки для любых других сообщений
        is_subscribed = await check_subscription(user_id)
        if not is_subscribed:
            await message.answer(
                "📢 Для использования бота необходимо подписаться на наш канал.\n\n"
                "После подписки нажмите кнопку '✅ Я подписался'",
                reply_markup=create_subscription_keyboard()
            )
            await state.set_state(UserStates.checking_subscription)
            return

        log_user_action(user_id, "UNEXPECTED_MSG", message.text[:50] if message.text else "")

        await message.answer(
            "🤖 Я помогаю рассчитать контрольные работы года и месяца\n\n"
            "Введите /start для начала"
        )
    except Exception as e:
        logger.error(f"Handle other error: {e}", extra={'user_id': 0})


# --- Главная функция ---
async def main():
    try:
        logger.info("🚀 Starting bot...", extra={'user_id': 'SYSTEM'})

        await load_data()
        statistics['session_start_time'] = datetime.now().isoformat()

        if BOT_TOKEN == "ВАШ_ТОКЕН":
            logger.error("❌ BOT_TOKEN not configured!", extra={'user_id': 'SYSTEM'})
            return

        bot_info = await bot.get_me()
        logger.info(f"✅ Bot @{bot_info.username} started", extra={'user_id': 'SYSTEM'})

        asyncio.create_task(periodic_save())

        await dp.start_polling(bot)

    except Exception as e:
        logger.error(f"❌ Fatal error: {e}", extra={'user_id': 'SYSTEM'})
    finally:
        await save_data()
        logger.info("💾 Data saved. Bot stopped", extra={'user_id': 'SYSTEM'})
        await bot.session.close()


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("⛔ Bot stopped by user", extra={'user_id': 'SYSTEM'})
    except Exception as e:
        logger.error(f"❌ Fatal error: {e}", extra={'user_id': 'SYSTEM'})
